@model ManagePostsViewModel
@{
    var posts = Model.Posts;
    var user = User;
    var isAdmin = ClaimsPrincipalExtensions.IsInRole(user, UserRolesConsts.Administrator);
}

@section Scripts {
    <script>
        function updatePost(button) {
            let slug = button.getAttribute('data-slug');
            let urlTemplate = button.getAttribute('data-url');
            window.location.href = urlTemplate.replace('__slug__', encodeURIComponent(slug));
        }

        function deletePost(button) {
            const postId = button.getAttribute('data-id');
            let deleteUrl = `@Url.Action("DeletePost", "Accounts")/${postId}`;

            showConfirmAlert(
                'Are you sure?',
                "You won't be able to revert this!",
                'Yes, delete it!',
                'Cancel',
                () => {
                    $.ajax({
                        url: deleteUrl,
                        type: 'DELETE',
                        contentType: 'application/json',
                        success: function(data) {
                            if (data.success) {
                                showSuccessNotification('Your post has been deleted.');
                                if (data.html) {
                                    $('#posts-table-body').html(data.html); // Update table content
                                }
                            } else {
                                showErrorNotification('There was a problem deleting your post.');
                            }
                        },
                        error: function() {
                            showErrorNotification('There was a problem deleting your post.');
                        }
                    });
                }
            );
        }

        function confirmPin(button) {
            showConfirmAlert(
                'Confirm Pin',
                'Are you sure you want to pin this post?',
                'Yes, Pin it',
                'Cancel',
                () => {
                    const postId = button.getAttribute('data-id');
                    pinPost(postId);
                }
            );
        }

        function confirmFeature(button) {
            showConfirmAlert(
                'Confirm Feature',
                'Are you sure you want to feature this post?',
                'Yes, Feature it',
                'Cancel',
                () => {
                    const postId = button.getAttribute('data-id');
                    featurePost(postId);
                }
            );
        }

        async function pinPost(postId) {
            try {
                console.log("Pin post:", postId);
                const response = await $.ajax({
                    url: `/accounts/toggle-pin-status/${postId}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        isPinned: true
                    })
                });

                if (response.success) {
                    $('#posts-table-body').html(response.html); // Update table content
                    showSuccessNotification('Post pinned successfully.');
                } else {
                    showErrorNotification('There was a problem pinning your post.');
                }
            } catch (error) {
                showErrorNotification(`Error pinning post: ${error.responseText || error.message}`);
            }
        }

        async function featurePost(postId) {
            try {
                console.log("Feature post:", postId);
                const response = await $.ajax({
                    url: `/accounts/toggle-featured-status/${postId}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        isFeatured: true
                    })
                });

                if (response.success) {
                    $('#posts-table-body').html(response.html); // Update table content
                    showSuccessNotification('Post featured successfully.');
                } else {
                    showErrorNotification('There was a problem featuring your post.');
                }
            } catch (error) {
                showErrorNotification(`Error featuring post: ${error.responseText || error.message}`);
            }
        }
    </script>
}

<div class="container single-content">
    <div class="entry-header entry-header-style-1 mb-50 pt-50 text-center">
        <h1 class="entry-title mb-20 font-weight-900">
            Manage posts
        </h1>
    </div>
    <div class="row mb-3">
        <div class="col-md-12 text-right-custom">
            <button class="btn btn-primary btn-block" onclick="location.href='@Url.Action("CreatePost", "Accounts")'">
                <i class="fa fa-edit"></i> Create new post
            </button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="table-wrap">
                <table class="table table-responsive-xl">
                    <thead>
                    <tr>
                        <th>&nbsp;</th>
                        <th style="min-width: 50px;">Pinned</th>
                        <th style="min-width: 50px;">Featured</th>
                        <th style="min-width: 100px;">Status</th>
                        <th style="min-width: 150px;">Category</th>
                        <th style="min-width: 300px;">Title</th>
                        <th style="min-width: 120px;">Created date</th>
                        <th style="min-width: 80px;">Views</th>
                        <th style="min-width: 80px;">Comments</th>
                        <th style="min-width: 80px;">Likes</th>
                        <th style="min-width: 150px;">Published date</th>
                        <th>&nbsp;</th>
                    </tr>
                    </thead>
                    <tbody id="posts-table-body">
                        @await Html.PartialAsync("Partials/Accounts/_PostsByCurrentUserTablePartial", Model)
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="6">
                            <div class="pagination-area mb-30">
                                @await Component.InvokeAsync("Pager", posts.MetaData)
                            </div>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>